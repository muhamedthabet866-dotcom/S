import streamlit as st
import pandas as pd
import requests
from io import BytesIO
import re

st.set_page_config(page_title="SPSS MBA Solver", layout="wide")

st.title("ğŸš€ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù…Ù†Ù‡Ø¬ SPSS")

# --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ¬Ù„Ø¨ Ø§Ù„Ù…Ù†Ù‡Ø¬ Ù…Ù† GitHub ---
GITHUB_RAW_URL = "https://github.com/muhamedthabet866-dotcom/S/raw/refs/heads/main/spss_rules.xlsx"

@st.cache_data
def load_rules(url):
    try:
        response = requests.get(url)
        return pd.read_excel(BytesIO(response.content))
    except:
        return None

rules_df = load_rules(GITHUB_RAW_URL)

# --- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
col1, col2 = st.columns(2)

with col1:
    st.subheader("âš™ï¸ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (Mapping)")
    # Ù…Ø«Ø§Ù„ Ù„Ù…Ø§ ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ù„ÙØ§ØªÙƒ
    mapping_input = st.text_area("Ø§Ù†Ø³Ø® Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù† Ø£Ø³ÙÙ„ ÙˆØ±Ù‚Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†:", 
                                value="X2=League\nX5=Salary\nX11=Surface\nX7=Wins", height=250)

with col2:
    st.subheader("ğŸ“ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†")
    questions_input = st.text_area("Ø§Ù„ØµÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§:", 
                                  value="Draw a bar chart for average salary for each league\nTest the normality of salary", height=250)

if st.button("ğŸš€ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø­Ù„ Ø§Ù„ÙƒØ§Ù…Ù„"):
    if rules_df is not None:
        # 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù€ Mapping Ù„Ù‚Ø§Ù…ÙˆØ³ (Name -> Code)
        mapping_dict = {}
        for line in mapping_input.split('\n'):
            if '=' in line:
                code, name = line.split('=')
                mapping_dict[name.strip().lower()] = code.strip().upper()

        final_syntax = ["* Generated by MBA Solver.\nSET SEED=1234567."]
        
        # 2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        questions = questions_input.split('\n')
        for q in questions:
            if not q.strip(): continue
            
            matched = False
            for _, rule in rules_df.iterrows():
                if rule['Keyword'].lower() in q.lower():
                    syntax = rule['Syntax_Template']
                    
                    # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ
                    for name, code in mapping_dict.items():
                        if name in q.lower():
                            syntax = syntax.replace("{var}", code).replace("{group}", code)
                    
                    final_syntax.append(f"\n* Question: {q}\n{syntax}\nEXECUTE.")
                    matched = True
                    break
            
            if not matched:
                final_syntax.append(f"\n* Question: {q}\n* [ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ù†Ù‡Ø¬ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„]")

        st.subheader("âœ… ÙƒÙˆØ¯ SPSS Syntax Ø§Ù„Ù…ÙˆÙ„Ø¯:")
        st.code("\n".join(final_syntax), language="spss")
    else:
        st.error("ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ù„Ù Ø§Ù„Ù…Ù†Ù‡Ø¬ Ù…Ù† GitHub. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·.")

