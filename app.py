import streamlit as st
import pandas as pd
import requests
from io import BytesIO
import re

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
st.set_page_config(page_title="MBA SPSS Smart Solver", layout="wide")

st.title("ğŸ“ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø­Ù„ Ø§Ù…ØªØ­Ø§Ù†Ø§Øª SPSS")
st.markdown("---")

# Ø±Ø§Ø¨Ø· Ù…Ù„Ù Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø¹Ù„Ù‰ GitHub (ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ø±Ø§Ø¨Ø·Ùƒ)
RULES_URL = "https://github.com/muhamedthabet866-dotcom/S/raw/refs/heads/main/spss_rules.xlsx"

@st.cache_data
def load_methodology(url):
    try:
        response = requests.get(url, timeout=10)
        return pd.read_excel(BytesIO(response.content))
    except:
        return None

rules_df = load_methodology(RULES_URL)

# --- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„Ù…Ù„ÙØ§Øª ÙˆØ§Ù„ØªØ¹Ø±ÙŠÙØ§Øª ---
with st.sidebar:
    st.header("ğŸ“ 1. Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
    data_file = st.file_uploader("Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„ (Dataset)", type=['xlsx', 'xls'])
    if data_file:
        df = pd.read_excel(data_file)
        st.success(f"ØªÙ… Ù‚Ø±Ø§Ø¡Ø© {len(df.columns)} Ù…ØªØºÙŠØ± Ù…Ù† Ø§Ù„Ù…Ù„Ù.")
    
    st.header("âš™ï¸ 2. ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª (Mapping)")
    st.info("Ø§ÙƒØªØ¨ Ø§Ù„ØªØ¹Ø±ÙŠÙ ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ ÙˆØ±Ù‚Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†")
    mapping_input = st.text_area("Ù…Ø«Ø§Ù„:\nX1=account balance\nX6=city", 
                                value="X1=account balance\nX2=ATM transactions\nX4=debit card\nX5=interest\nX6=city", 
                                height=200)

# --- Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø­Ù„ ---
st.header("ğŸ“ 3. Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†")
questions_input = st.text_area("Ø§Ù„ØµÙ‚ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‡Ù†Ø§:", height=300, placeholder="1. Draw a bar chart for average account balance per city...")

if st.button("ğŸš€ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø­Ù„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ Ø§Ù„Ø°ÙƒÙŠ"):
    if not questions_input.strip() or rules_df is None:
        st.error("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ù…Ù„Ù Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø¨Ù€ GitHub.")
    else:
        # 1. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù€ Mapping Ù„Ù‚Ø§Ù…ÙˆØ³ Ø°ÙƒÙŠ
        mapping_dict = {}
        for line in mapping_input.split('\n'):
            if '=' in line:
                parts = line.split('=')
                mapping_dict[parts[1].strip().lower()] = parts[0].strip().upper()
        
        # ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø·ÙˆÙ„ Ù„Ù„Ø£Ù‚ØµØ± Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        sorted_var_names = sorted(mapping_dict.keys(), key=len, reverse=True)

        final_syntax = ["* Generated by MBA Smart Solver.\nSET DECIMALS=DOT.\n"]

        # 2. ØªÙ‚Ø³ÙŠÙ… ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        # ØªÙ‚Ø³ÙŠÙ… Ø¨Ø§Ù„Ø³Ø·Ø± ÙˆØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø±Ù…ÙˆØ² ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ø¤Ø§Ù„
        lines = questions_input.split('\n')
        
        for q in lines:
            q_clean = q.strip()
            if not q_clean or len(q_clean) < 5: continue
            
            # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù„Ù„Ø¨Ø­Ø«
            search_q = re.sub(r'^\d+[\.\)\s\t]+', '', q_clean).lower()
            
            matched = False
            # Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†Ù‡Ø¬ (Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©)
            for _, rule in rules_df.iterrows():
                keyword = str(rule['Keyword']).lower().strip()
                
                if keyword in search_q:
                    syntax_template = str(rule['Syntax_Template'])
                    
                    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„
                    found_vars = []
                    for name in sorted_var_names:
                        if name in search_q:
                            found_vars.append(mapping_dict[name])
                    
                    if found_vars:
                        # Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨
                        unique_vars = list(dict.fromkeys(found_vars))
                        
                        # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ {var} Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…ÙƒØªØ´ÙØ©
                        res_syntax = syntax_template.replace("{var}", " ".join(unique_vars))
                        
                        # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ {group} Ø¨Ø¢Ø®Ø± Ù…ØªØºÙŠØ± (ØºØ§Ù„Ø¨Ø§Ù‹ ÙŠÙƒÙˆÙ† Ù…ØªØºÙŠØ± Ø§Ù„ØªØµÙ†ÙŠÙ Ù…Ø«Ù„ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø£Ùˆ Ø§Ù„Ù†ÙˆØ¹)
                        if "{group}" in res_syntax:
                            group_var = unique_vars[-1] if len(unique_vars) > 1 else unique_vars[0]
                            res_syntax = res_syntax.replace("{group}", group_var)
                        
                        final_syntax.append(f"* Question: {q_clean}")
                        final_syntax.append(f"{res_syntax}\nEXECUTE.")
                        matched = True
                        break
            
            if not matched:
                final_syntax.append(f"* Question: {q_clean}\n* [!] Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ù…Ø·Ø§Ø¨Ù‚Ø© ÙÙŠ Ø§Ù„Ù…Ù†Ù‡Ø¬.")

        st.subheader("âœ… ÙƒÙˆØ¯ SPSS Syntax Ø§Ù„Ù…ÙˆÙ„Ø¯:")
        st.code("\n".join(final_syntax), language="spss")
