import pandas as pd
import os
import re
from pathlib import Path

class SPSS_Code_Generator:
    def __init__(self):
        self.datasets = {}
        
    def load_excel_data(self, file_path):
        """تحميل بيانات Excel"""
        try:
            # محاولة قراءة جميع الورقات
            excel_file = pd.ExcelFile(file_path)
            sheets_data = {}
            
            for sheet_name in excel_file.sheet_names:
                df = pd.read_excel(file_path, sheet_name=sheet_name)
                if not df.empty:
                    sheets_data[sheet_name] = df
                    
            return sheets_data
        except Exception as e:
            print(f"خطأ في تحميل ملف Excel {file_path}: {e}")
            return {}
    
    def parse_word_questions(self, file_path):
        """قراءة وتحليل أسئلة ملف Word"""
        questions = []
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()
                
            # استخراج الأسئلة المرقمة
            lines = content.split('\n')
            current_question = ""
            
            for line in lines:
                # البحث عن بداية سؤال مرقم
                if re.match(r'^\d+\.', line.strip()):
                    if current_question:
                        questions.append(current_question.strip())
                    current_question = line
                elif current_question and line.strip():
                    current_question += " " + line
            
            if current_question:
                questions.append(current_question.strip())
                
        except Exception as e:
            print(f"خطأ في قراءة ملف Word {file_path}: {e}")
            
        return questions
    
    def generate_spss_syntax(self, dataset_name, questions, data_dict):
        """توليد كود SPSS بناءً على الأسئلة والبيانات"""
        spss_code = f"* SPSS Syntax for {dataset_name}\n"
        spss_code += "* Generated by Python SPSS Code Generator\n"
        spss_code += "************************************************.\n\n"
        
        for i, question in enumerate(questions, 1):
            spss_code += f"* Question {i}: {question}\n"
            spss_code += self.generate_question_code(question, data_dict)
            spss_code += "\n" + "="*50 + "\n\n"
        
        return spss_code
    
    def generate_question_code(self, question, data_dict):
        """توليد كود SPSS لسؤال محدد"""
        code = ""
        
        # التحقق من نوع السؤال وتوليد الكود المناسب
        question_lower = question.lower()
        
        # 1. جداول التكرار للبيانات الفئوية
        if 'frequency table' in question_lower and ('categorical' in question_lower or 'discrete' in question_lower):
            code += self.generate_frequency_table_code(question, data_dict, categorical=True)
        
        # 2. جداول التكرار للبيانات المستمرة
        elif 'frequency table' in question_lower and 'continuous' in question_lower:
            code += self.generate_frequency_table_code(question, data_dict, categorical=False)
        
        # 3. الرسوم البيانية
        elif 'bar chart' in question_lower:
            code += self.generate_chart_code(question, data_dict, chart_type='bar')
        
        # 4. الرسوم الدائرية
        elif 'pie chart' in question_lower:
            code += self.generate_chart_code(question, data_dict, chart_type='pie')
        
        # 5. الإحصاءات الوصفية
        elif any(term in question_lower for term in ['mean', 'median', 'mode', 'standard deviation', 'range', 'maximum', 'minimum']):
            code += self.generate_descriptive_stats_code(question, data_dict)
        
        # 6. فترات الثقة
        elif 'confidence interval' in question_lower:
            code += self.generate_confidence_interval_code(question, data_dict)
        
        # 7. اختبارات الفرضيات
        elif 'hypothesis' in question_lower or 'test' in question_lower:
            code += self.generate_hypothesis_test_code(question, data_dict)
        
        # 8. اكتشاف القيم المتطرفة
        elif 'outliers' in question_lower or 'extremes' in question_lower:
            code += self.generate_outliers_code(question, data_dict)
        
        # 9. الارتباط والانحدار
        elif 'correlation' in question_lower or 'regression' in question_lower:
            code += self.generate_correlation_regression_code(question, data_dict)
        
        else:
            code += "* Manual analysis required - cannot generate automatic code\n"
            code += f"* Question type not recognized: {question[:50]}...\n"
        
        return code
    
    def generate_frequency_table_code(self, question, data_dict, categorical=True):
        """توليد كود لجداول التكرار"""
        code = ""
        df = next(iter(data_dict.values())) if data_dict else None
        
        if df is not None:
            # استخراج أسماء المتغيرات من السؤال
            if categorical:
                # البحث عن متغيرات فئوية في السؤال
                vars_found = []
                for col in df.columns:
                    if any(word in question.lower() for word in col.lower().split()):
                        vars_found.append(col)
                
                for var in vars_found:
                    code += f"FREQUENCIES VARIABLES={var}\n"
                    code += "  /ORDER=ANALYSIS.\n"
            else:
                # للمتغيرات المستمرة مع فئات
                code += "* For continuous variables with classes:\n"
                code += "DESCRIPTIVES VARIABLES=ALL\n"
                code += "  /STATISTICS=MEAN STDDEV MIN MAX.\n"
                code += "\n* To create frequency tables with classes:\n"
                code += "RECODE {variable} (Lowest thru {value1}=1) ({value1} thru {value2}=2) ...\n"
                code += "  /INTO {variable}_cat.\n"
                code += "VALUE LABELS {variable}_cat 1 'Class 1' 2 'Class 2' ...\n"
                code += "FREQUENCIES VARIABLES={variable}_cat.\n"
        
        return code
    
    def generate_chart_code(self, question, data_dict, chart_type='bar'):
        """توليد كود للرسوم البيانية"""
        code = ""
        
        if chart_type == 'bar':
            code += "GRAPH\n"
            code += "  /BAR(SIMPLE)=[MEAN|COUNT|SUM]({variable}) BY {category}\n"
            code += "  /TITLE='Bar Chart'.\n"
        elif chart_type == 'pie':
            code += "GRAPH\n"
            code += "  /PIE=[MEAN|SUM|COUNT]({variable}) BY {category}\n"
            code += "  /TITLE='Pie Chart'.\n"
        
        return code
    
    def generate_descriptive_stats_code(self, question, data_dict):
        """توليد كود للإحصاءات الوصفية"""
        code = "DESCRIPTIVES VARIABLES=ALL\n"
        code += "  /STATISTICS=MEAN STDDEV MIN MAX RANGE MEDIAN MODE.\n"
        code += "\nEXAMINE VARIABLES=ALL\n"
        code += "  /PLOT BOXPLOT STEMLEAF HISTOGRAM\n"
        code += "  /COMPARE GROUP\n"
        code += "  /STATISTICS DESCRIPTIVES\n"
        code += "  /CINTERVAL 95\n"
        code += "  /MISSING LISTWISE\n"
        code += "  /NOTOTAL.\n"
        return code
    
    def generate_confidence_interval_code(self, question, data_dict):
        """توليد كود لفترات الثقة"""
        code = "EXAMINE VARIABLES={variable}\n"
        code += "  /PLOT NONE\n"
        code += "  /STATISTICS DESCRIPTIVES\n"
        code += "  /CINTERVAL 95 99\n"
        code += "  /MISSING LISTWISE\n"
        code += "  /NOTOTAL.\n"
        return code
    
    def generate_hypothesis_test_code(self, question, data_dict):
        """توليد كود لاختبارات الفرضيات"""
        code = ""
        
        # تحليل نوع اختبار الفرضية
        if 'average' in question_lower or 'mean' in question_lower:
            # اختبار t لعينة واحدة
            code += "* One-sample t-test:\n"
            code += "T-TEST\n"
            code += "  /TESTVAL={value}\n"
            code += "  /MISSING=ANALYSIS\n"
            code += "  /VARIABLES={variable}\n"
            code += "  /CRITERIA=CI(.95).\n"
        
        elif 'difference' in question_lower and 'between' in question_lower:
            # اختبار t لعينتين مستقلتين
            code += "* Independent samples t-test:\n"
            code += "T-TEST GROUPS={grouping_variable}({value1} {value2})\n"
            code += "  /MISSING=ANALYSIS\n"
            code += "  /VARIABLES={dependent_variable}\n"
            code += "  /CRITERIA=CI(.95).\n"
        
        elif 'anova' in question_lower or 'more than two' in question_lower:
            # تحليل التباين
            code += "* One-way ANOVA:\n"
            code += "ONEWAY {dependent_variable} BY {grouping_variable}(1, {n_groups})\n"
            code += "  /STATISTICS DESCRIPTIVES HOMOGENEITY\n"
            code += "  /MISSING ANALYSIS\n"
            code += "  /POSTHOC=TUKEY ALPHA(0.05).\n"
        
        return code
    
    def generate_outliers_code(self, question, data_dict):
        """توليد كود للكشف عن القيم المتطرفة"""
        code = "EXAMINE VARIABLES={variable}\n"
        code += "  /PLOT=BOXPLOT STEMLEAF\n"
        code += "  /COMPARE VARIABLES\n"
        code += "  /STATISTICS=EXTREME\n"
        code += "  /CINTERVAL 95\n"
        code += "  /MISSING=LISTWISE\n"
        code += "  /NOTOTAL.\n"
        return code
    
    def generate_correlation_regression_code(self, question, data_dict):
        """توليد كود للارتباط والانحدار"""
        code = ""
        
        if 'correlation' in question_lower:
            code += "* Correlation analysis:\n"
            code += "CORRELATIONS\n"
            code += "  /VARIABLES={var1} {var2}\n"
            code += "  /PRINT=TWOTAIL NOSIG\n"
            code += "  /MISSING=PAIRWISE.\n"
        
        elif 'regression' in question_lower:
            code += "* Multiple linear regression:\n"
            code += "REGRESSION\n"
            code += "  /MISSING LISTWISE\n"
            code += "  /STATISTICS COEFF OUTS R ANOVA\n"
            code += "  /CRITERIA=PIN(.05) POUT(.10)\n"
            code += "  /NOORIGIN\n"
            code += "  /DEPENDENT {dependent_var}\n"
            code += "  /METHOD=ENTER {independent_vars}.\n"
        
        return code
    
    def process_all_datasets(self, base_path="."):
        """معالجة جميع مجموعات البيانات"""
        # البحث عن جميع ملفات Excel وWord في المجلد
        excel_files = []
        word_files = []
        
        for file in os.listdir(base_path):
            if file.endswith('.xls') or file.endswith('.xlsx'):
                excel_files.append(file)
            elif file.endswith('.doc') or file.endswith('.docx'):
                word_files.append(file)
        
        print(f"تم العثور على {len(excel_files)} ملفات Excel")
        print(f"تم العثور على {len(word_files)} ملفات Word")
        
        # معالجة كل مجموعة بيانات
        for i, excel_file in enumerate(excel_files, 1):
            dataset_name = f"Data set {i}"
            excel_path = os.path.join(base_path, excel_file)
            
            # تحميل بيانات Excel
            data_dict = self.load_excel_data(excel_path)
            
            if data_dict:
                print(f"تم تحميل {excel_file} بنجاح")
                
                # البحث عن ملف الأسئلة المقابل
                matching_word_file = None
                for word_file in word_files:
                    if f"data set {i}" in word_file.lower():
                        matching_word_file = word_file
                        break
                
                if matching_word_file:
                    word_path = os.path.join(base_path, matching_word_file)
                    questions = self.parse_word_questions(word_path)
                    
                    if questions:
                        # توليد كود SPSS
                        spss_code = self.generate_spss_syntax(dataset_name, questions, data_dict)
                        
                        # حفظ كود SPSS في ملف
                        output_file = f"SPSS_Syntax_Dataset_{i}.sps"
                        with open(output_file, 'w', encoding='utf-8') as f:
                            f.write(spss_code)
                        
                        print(f"تم إنشاء ملف SPSS: {output_file}")
                        print(f"عدد الأسئلة المعالجة: {len(questions)}")
                        
                        # عرض عينة من الكود
                        print("\nعينة من كود SPSS المُنشأ:")
                        print(spss_code[:500] + "...\n")
                    else:
                        print(f"لم يتم العثور على أسئلة في ملف Word: {matching_word_file}")
                else:
                    print(f"لم يتم العثور على ملف Word مطابق لـ {excel_file}")
            else:
                print(f"فشل تحميل ملف Excel: {excel_file}")
        
        print("\n" + "="*50)
        print("اكتملت عملية توليد أكواد SPSS")
    
    def create_comprehensive_template(self):
        """إنشاء قالب شامل لجميع أنواع التحليلات"""
        template = """
* SPSS Syntax Template - Comprehensive Analysis
* Includes all common statistical procedures

************************************************.
* 1. DATA PREPARATION
************************************************.

* Define variable properties.
VARIABLE LABELS
  var1 'Description of variable 1'
  var2 'Description of variable 2'.

* Define value labels.
VALUE LABELS
  gender 1 'Male' 2 'Female'
  group 1 'Control' 2 'Treatment' 3 'Placebo'.

************************************************.
* 2. DESCRIPTIVE STATISTICS
************************************************.

* Frequency tables for categorical variables.
FREQUENCIES VARIABLES=gender group
  /ORDER=ANALYSIS.

* Descriptive statistics for continuous variables.
DESCRIPTIVES VARIABLES=age income score
  /STATISTICS=MEAN STDDEV MIN MAX SKEWNESS KURTOSIS.

* Explore command for detailed analysis.
EXAMINE VARIABLES=age income score BY gender
  /PLOT=BOXPLOT HISTOGRAM STEMLEAF
  /COMPARE GROUP
  /STATISTICS DESCRIPTIVES
  /CINTERVAL 95
  /MISSING LISTWISE
  /NOTOTAL.

************************************************.
* 3. DATA VISUALIZATION
************************************************.

* Bar charts.
GRAPH
  /BAR(SIMPLE)=MEAN(score) BY group
  /TITLE='Mean Score by Group'.

* Histograms.
GRAPH
  /HISTOGRAM=score
  /TITLE='Distribution of Scores'.

* Scatter plots.
GRAPH
  /SCATTERPLOT(BIVAR)=income WITH score
  /TITLE='Income vs Score'.

************************************************.
* 4. INFERENTIAL STATISTICS
************************************************.

* One-sample t-test.
T-TEST
  /TESTVAL=100
  /MISSING=ANALYSIS
  /VARIABLES=score
  /CRITERIA=CI(.95).

* Independent samples t-test.
T-TEST GROUPS=gender(1 2)
  /MISSING=ANALYSIS
  /VARIABLES=income score
  /CRITERIA=CI(.95).

* Paired samples t-test.
T-TEST PAIRS=pre_score WITH post_score (PAIRED)
  /CRITERIA=CI(.9500)
  /MISSING=ANALYSIS.

* One-way ANOVA.
ONEWAY score BY group(1,3)
  /STATISTICS DESCRIPTIVES HOMOGENEITY
  /MISSING ANALYSIS
  /POSTHOC=TUKEY LSD ALPHA(0.05).

* Correlation analysis.
CORRELATIONS
  /VARIABLES=income score age
  /PRINT=TWOTAIL NOSIG
  /MISSING=PAIRWISE.

* Chi-square test.
CROSSTABS
  /TABLES=gender BY group
  /FORMAT=AVALUE TABLES
  /STATISTICS=CHISQ
  /CELLS=COUNT EXPECTED
  /COUNT ROUND CELL.

************************************************.
* 5. REGRESSION ANALYSIS
************************************************.

* Linear regression.
REGRESSION
  /MISSING LISTWISE
  /STATISTICS COEFF OUTS R ANOVA
  /CRITERIA=PIN(.05) POUT(.10)
  /NOORIGIN
  /DEPENDENT score
  /METHOD=ENTER income age.

* Multiple regression with stepwise.
REGRESSION
  /DESCRIPTIVES MEAN STDDEV CORR SIG N
  /MISSING LISTWISE
  /STATISTICS COEFF OUTS R ANOVA CHANGE
  /CRITERIA=PIN(.05) POUT(.10)
  /NOORIGIN
  /DEPENDENT score
  /METHOD=STEPWISE income age education experience.

************************************************.
* 6. NONPARAMETRIC TESTS
************************************************.

* Mann-Whitney U test.
NPAR TESTS
  /M-W= score BY gender(1 2)
  /MISSING ANALYSIS.

* Kruskal-Wallis test.
NPAR TESTS
  /K-W=score BY group(1 3)
  /MISSING ANALYSIS.

* Wilcoxon signed-rank test.
NPAR TESTS
  /WILCOXON=pre_score WITH post_score (PAIRED)
  /MISSING ANALYSIS.

************************************************.
* 7. RELIABILITY ANALYSIS
************************************************.

* Cronbach's alpha.
RELIABILITY
  /VARIABLES=item1 item2 item3 item4 item5
  /SCALE('Total Scale') ALL
  /MODEL=ALPHA.

************************************************.
* 8. FACTOR ANALYSIS
************************************************.

* Principal component analysis.
FACTOR
  /VARIABLES=item1 item2 item3 item4 item5 item6
  /MISSING LISTWISE
  /ANALYSIS item1 item2 item3 item4 item5 item6
  /PRINT INITIAL EXTRACTION ROTATION
  /CRITERIA MINEIGEN(1) ITERATE(25)
  /EXTRACTION PC
  /CRITERIA ITERATE(25)
  /ROTATION VARIMAX
  /METHOD=CORRELATION.

************************************************.
* 9. DATA MANAGEMENT
************************************************.

* Recode variables.
RECODE age (18 thru 30=1) (31 thru 45=2) (46 thru 60=3) (61 thru HIGHEST=4)
  INTO age_group.
VALUE LABELS age_group 1 '18-30' 2 '31-45' 3 '46-60' 4 '61+'.

* Compute new variables.
COMPUTE bmi = weight / ((height/100) ** 2).
VARIABLE LABELS bmi 'Body Mass Index'.

* Select cases.
USE ALL.
COMPUTE filter_$=(gender = 1 & age > 30).
VARIABLE LABELS filter_$ 'gender = 1 & age > 30 (FILTER)'.
VALUE LABELS filter_$ 0 'Not Selected' 1 'Selected'.
FORMATS filter_$ (f1.0).
FILTER BY filter_$.
EXECUTE.

************************************************.
* END OF SYNTAX
************************************************.
"""
        
        with open("SPSS_Comprehensive_Template.sps", 'w', encoding='utf-8') as f:
            f.write(template)
        print("تم إنشاء القالب الشامل: SPSS_Comprehensive_Template.sps")
        return template


# تشغيل البرنامج
if __name__ == "__main__":
    generator = SPSS_Code_Generator()
    
    # إنشاء القالب الشامل
    print("جاري إنشاء القالب الشامل لتحليل SPSS...")
    generator.create_comprehensive_template()
    
    # معالجة مجموعات البيانات
    print("\nجاري معالجة مجموعات البيانات...")
    generator.process_all_datasets(".")
    
    print("\n" + "="*50)
    print("إرشادات الاستخدام:")
    print("1. ضع ملفات Excel وWord في نفس مجلد البرنامج")
    print("2. تأكد من تطابق أسماء الملفات (Data set 1.xls مع SPSS questions For data set 1.doc)")
    print("3. سيتم إنشاء ملفات .sps لكل مجموعة بيانات")
    print("4. افتح ملفات .sps في برنامج SPSS وقم بتنفيذ الأوامر")
    print("5. للبيانات الحقيقية، استبدل {variable} و{category} بأسماء المتغيرات الفعلية")
    print("="*50)
