import streamlit as st
import pandas as pd
from docx import Document
import re
import io

# ุฏุงูุฉ ุชูููุฏ ุงูุณููุชุงูุณ ุจูุงุกู ุนูู ุงููููุฌ (ุงููุตูู 1-10)
def generate_spss_syntax_v26(doc_upload, excel_vars):
    doc_bytes = doc_upload.read()
    try:
        doc = Document(io.BytesIO(doc_bytes))
        paragraphs = [p.text.strip() for p in doc.paragraphs if p.text.strip()]
    except:
        paragraphs = re.findall(r'[ -~]{5,}', doc_bytes.decode('ascii', errors='ignore'))

    # ุฅุนุฏุงุฏุงุช ุงูุจุฏุงูุฉ ูู SPSS v26
    syntax = [
        "* Encoding: UTF-8.",
        "SET UNICODE=ON.",
        "SET DECIMAL=DOT.",
        "* --- Generated by Statistics Curriculum Engine (v26) --- *.\n"
    ]

    # ุฎุฑูุทุฉ ุงููุชุบูุฑุงุช ุงูุงูุชุฑุงุถูุฉ ุฅุฐุง ูู ูุชู ุชุญุฏูุฏูุง ูู ุงูููุฑุฏ
    # ุณูุญุงูู ูุทุงุจูุฉ ุงููููุงุช ูู ุงูููุฑุฏ ูุน ุฃุณูุงุก ุงูุฃุนูุฏุฉ ูู ุงูุฅูุณูู
    cols = excel_vars if excel_vars else ["X1", "X2", "X3", "X4", "X5"]
    
    for p in paragraphs:
        p_low = p.lower()
        syntax.append(f"\n* QUESTION: {p}.")

        # 1. ุงุฎุชุจุงุฑุงุช T-Test (Chapter 4 & 5)
        if "independent" in p_low and "t-test" in p_low:
            # ูุซุงู: ููุงุฑูุฉ X1 ุจูุงุกู ุนูู ูุฌููุนุงุช X4
            syntax.append(f"T-TEST GROUPS={cols[3]}(0 1) /MISSING=ANALYSIS /VARIABLES={cols[0]} /CRITERIA=CI(.95).")
        
        elif "paired" in p_low or "before" in p_low or "after" in p_low:
            # ูุซุงู: ููุงุฑูุฉ X1 ูุจู ู X2 ุจุนุฏ
            syntax.append(f"T-TEST PAIRS={cols[0]} WITH {cols[1]} (PAIRED) /CRITERIA=CI(.95) /MISSING=ANALYSIS.")

        # 2. ุชุญููู ุงูุชุจุงูู ANOVA (Chapter 6)
        elif "anova" in p_low or "one-way" in p_low:
            syntax.append(f"ONEWAY {cols[0]} BY {cols[3]} /STATISTICS DESCRIPTIVES /POSTHOC=TUKEY ALPHA(0.05).")

        # 3. ุงูุงุฑุชุจุงุท (Chapter 8)
        elif "correlation" in p_low or "relationship" in p_low:
            method = "SPEARMAN" if "rank" in p_low or "non-parametric" in p_low else "PEARSON"
            syntax.append(f"CORRELATIONS /VARIABLES={cols[0]} {cols[1]} /PRINT=TWOTAIL NOSIG /METHOD={method}.")

        # 4. ุงูุงูุญุฏุงุฑ ุงูุจุณูุท ูุงููุชุนุฏุฏ (Chapter 9 & 10)
        elif "regression" in p_low or "predict" in p_low:
            if "stepwise" in p_low:
                syntax.append(f"REGRESSION /MISSING LISTWISE /STATISTICS COEFF OUTS R ANOVA COLLIN TOL /DEPENDENT {cols[0]} /METHOD=STEPWISE {cols[1]} {cols[2]}.")
            else:
                syntax.append(f"REGRESSION /MISSING LISTWISE /STATISTICS COEFF OUTS R ANOVA /DEPENDENT {cols[0]} /METHOD=ENTER {cols[1]}.")

        # 5. ุงูุงุฎุชุจุงุฑุงุช ุบูุฑ ุงููุนูููุฉ (Chapter 7)
        elif "mann-whitney" in p_low:
            syntax.append(f"NPAR TESTS /MWU= {cols[0]} BY {cols[3]}(0 1) /MISSING ANALYSIS.")
        elif "wilcoxon" in p_low:
            syntax.append(f"NPAR TESTS /WILCOXON= {cols[0]} WITH {cols[1]} (PAIRED) /MISSING ANALYSIS.")
        elif "chi-square" in p_low:
            syntax.append(f"CROSSTABS /TABLES={cols[3]} BY {cols[4]} /STATISTICS=CHISQ.")

        # 6. ุงูุฅุญุตุงุก ุงููุตูู ูุงุฎุชุจุงุฑ ุงูุชูุฒูุน ุงูุทุจูุนู (Chapter 2 & 3)
        elif "normality" in p_low or "examine" in p_low:
            syntax.append(f"EXAMINE VARIABLES={cols[0]} /PLOT NPPLOT /STATISTICS DESCRIPTIVES.")
        else:
            # ุงูุชุฑุงุถู: ุฅุญุตุงุก ูุตูู ุจุณูุท
            syntax.append(f"FREQUENCIES VARIABLES={cols[0]} /STATISTICS=MEAN MEDIAN MODE STDDEV.")

    syntax.append("\nEXECUTE.")
    return "\n".join(syntax)

# ูุงุฌูุฉ ุงููุณุชุฎุฏู Streamlit
st.set_page_config(page_title="SPSS Curriculum Automator", layout="wide")
st.title("๐ ูุญูู ูููุฌ ุงูุฅุญุตุงุก ุฅูู SPSS Syntax (v26)")
st.write("ุงุฑูุน ูููุงุชู ูุชุญููู ูุชุทูุจุงุช ุงูููุฑุฏ ุฅูู ููุฏ SPSS ุฌุงูุฒ ููุชูููุฐ.")

col1, col2 = st.columns(2)

with col1:
    u_excel = st.file_uploader("1. ุงุฑูุน ููู ุงูุจูุงูุงุช (Excel)", type=['xlsx', 'xls', 'csv'])
with col2:
    u_word = st.file_uploader("2. ุงุฑูุน ููู ุงููุชุทูุจุงุช (Word)", type=['docx'])

if u_excel and u_word:
    try:
        # ูุฑุงุกุฉ ุฃุณูุงุก ุงูุฃุนูุฏุฉ ูู ุงูุฅูุณูู ูุชูุฑูุฑูุง ูููุญุฑู
        df = pd.read_excel(u_excel)
        excel_vars = df.columns.tolist()
        
        st.info(f"๐ ุชู ุงูุนุซูุฑ ุนูู ุงููุชุบูุฑุงุช ุงูุชุงููุฉ: {', '.join(excel_vars)}")
        
        # ุชูููุฏ ุงูู Syntax
        final_syntax = generate_spss_syntax_v26(u_word, excel_vars)
        
        st.success("โ ุชู ุชูููุฏ ุงูููุฏ ุจูุฌุงุญ ูููุงู ููุนุงููุฑ ุงููููุฌ.")
        
        # ุนุฑุถ ุงูููุฏ
        st.code(final_syntax, language='spss')
        
        # ุฒุฑ ุงูุชุญููู
        st.download_button(
            label="ุชุญููู ููู ุงูุณููุชุงูุณ (.sps)",
            data=final_syntax,
            file_name="SPSS_Analysis_Script.sps",
            mime="text/plain"
        )
    except Exception as e:
        st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุนุงูุฌุฉ: {e}")
