import streamlit as st
import pandas as pd
from docx import Document
import io

# Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙˆÙˆØ±Ø¯
def safe_parse_word(doc_file):
    doc = Document(doc_file)
    questions = []
    for p in doc.paragraphs:
        text = p.text.strip()
        # Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ø³Ø·Ø± Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± ÙØ§Ø±Øº ÙˆØ·ÙˆÙ„Ù‡ Ù…Ø¹Ù‚ÙˆÙ„
        if len(text) > 2:
            questions.append(text)
    return questions

st.set_page_config(page_title="SPSS Generator Pro", layout="wide")
st.title("ğŸ› ï¸ Ù…ÙˆÙ„Ø¯ Ø³ÙŠÙ†ØªØ§ÙƒØ³ SPSS Ø§Ù„Ù…Ø·ÙˆØ±")

# Ù…Ù†Ø·Ù‚Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
col1, col2 = st.columns(2)
with col1:
    up_excel = st.file_uploader("1. Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¥ÙƒØ³ÙŠÙ„", type=['xlsx'])
with col2:
    up_word = st.file_uploader("2. Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ÙˆÙˆØ±Ø¯", type=['docx'])

if up_excel and up_word:
    try:
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        df = pd.read_excel(up_excel)
        word_questions = safe_parse_word(up_word)
        
        excel_cols = df.columns.tolist()
        
        st.info(f"ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {len(excel_cols)} Ø£Ø¹Ù…Ø¯Ø© ÙÙŠ Ø¥ÙƒØ³ÙŠÙ„ Ùˆ {len(word_questions)} Ø£Ø³Ø·Ø± ÙÙŠ ÙˆÙˆØ±Ø¯.")

        # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø³ÙŠÙ†ØªØ§ÙƒØ³
        syntax_content = ["* SPSS Syntax Generated by Eng. Mohamed Tool.\n"]
        
        # Ø§Ù„Ø±Ø¨Ø· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ù„ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        limit = min(len(excel_cols), len(word_questions))
        
        for i in range(limit):
            col_name = excel_cols[i]
            question = word_questions[i].replace("'", "") # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ù…Ù† Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø§Ù‚ØªØ¨Ø§Ø³
            syntax_content.append(f"VARIABLE LABELS {col_name} '{question}'.")
        
        syntax_content.append("\nEXECUTE.")
        final_syntax = "\n".join(syntax_content)

        # Ø§Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
        st.divider()
        st.subheader("Ø§Ù„Ù†ØªØ§Ø¦Ø¬:")
        
        # Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡
        st.code(final_syntax, language='spss')
        
        # Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹: data ØªØ£Ø®Ø° Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙˆÙ„Ø¯)
        st.download_button(
            label="ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ø³ÙŠÙ†ØªØ§ÙƒØ³ (.sps)",
            data=final_syntax,
            file_name="my_syntax.sps",
            mime="text/plain"
        )
        
    except Exception as e:
        st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙ†ÙŠ: {e}")
